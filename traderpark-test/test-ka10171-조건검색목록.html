<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¡°ê±´ê²€ìƒ‰ (ka10171 + ka10172)</title>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a2e;
            color: #eee;
        }
        h1 {
            color: #00d4ff;
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 10px;
        }
        .section {
            background-color: #16213e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section h2 {
            color: #00d4ff;
            margin-top: 0;
        }
        button {
            background-color: #00d4ff;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #00a8cc;
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.connected {
            background-color: #2ed573;
            color: #1a1a2e;
        }
        .status.disconnected {
            background-color: #ff4757;
            color: white;
        }
        .status.connecting {
            background-color: #ffa502;
            color: #1a1a2e;
        }
        #log {
            background-color: #0f0f23;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px;
            height: 260px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #333;
        }
        .log-entry.send {
            color: #00d4ff;
        }
        .log-entry.receive {
            color: #2ed573;
        }
        .log-entry.error {
            color: #ff4757;
        }
        .log-entry.info {
            color: #ffa502;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #333;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #0f3460;
            color: #00d4ff;
        }
        tr:nth-child(even) {
            background-color: #1a1a2e;
        }
        .loading {
            text-align: center;
            color: #888;
            padding: 30px;
        }
        .error {
            background-color: #ff475733;
            border: 1px solid #ff4757;
            border-radius: 5px;
            padding: 15px;
            color: #ff6b7a;
        }
        tr.clickable {
            cursor: pointer;
        }
        tr.clickable:hover {
            background-color: #0f3460 !important;
        }
        tr.selected {
            background-color: #00d4ff33 !important;
        }
        .price-up {
            color: #ff4757;
        }
        .price-down {
            color: #2ed573;
        }
        .price-same {
            color: #888;
        }
        .stock-count {
            color: #00d4ff;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .selected-condition {
            background-color: #0f3460;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            color: #00d4ff;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ì¡°ê±´ê²€ìƒ‰ (ka10171 + ka10172)</h1>

    <div class="section">
        <h2>ì—°ê²°/ì¡°íšŒ</h2>
        <button id="btnConnect" onclick="connectWebSocket()">ì—°ê²°</button>
        <button id="btnRequest" onclick="requestConditionList()" disabled>ëª©ë¡ì¡°íšŒ</button>
        <button id="btnDisconnect" onclick="disconnectWebSocket()" disabled>ì—°ê²° í•´ì œ</button>
        <div id="status" class="status disconnected">ì—°ê²° ì•ˆë¨</div>
    </div>

    <div class="section">
        <h2>ì¡°ê±´ê²€ìƒ‰ì‹ ëª©ë¡</h2>
        <div id="result">
            <div class="loading">ì—°ê²° í›„ ëª©ë¡ì¡°íšŒ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
        </div>
    </div>

    <div class="section">
        <h2>ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (ka10172)</h2>
        <div id="selectedCondition"></div>
        <div id="stockResult">
            <div class="loading">ì¡°ê±´ê²€ìƒ‰ì‹ì„ í´ë¦­í•˜ë©´ ì¢…ëª©ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
        </div>
    </div>

    <div class="section">
        <h2>ë¡œê·¸</h2>
        <div id="log"></div>
    </div>

    <script>
        const HOST = 'https://api.kiwoom.com'; // í† í° ë°œê¸‰ìš©
        const WS_URL = 'wss://api.kiwoom.com:10000/api/dostk/websocket';
        const APP_KEY = 'S0pnAkH0NIhvkRqlSbTa2j0y42ikEw6x26UKpAoZouQ';
        const SECRET_KEY = 'h6wV7B6PJeDa_hv7HFuKbtvaOzwIKU-gtoQXEzyxm68';

        let ws = null;
        let accessToken = null;
        let authOk = false;
        let authPending = false;
        let selectedCondition = null; // ì„ íƒëœ ì¡°ê±´ê²€ìƒ‰ì‹

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(status, text) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${status}`;
            statusDiv.textContent = text;
        }

        async function getAccessToken() {
            const url = HOST + '/oauth2/token';
            const body = {
                'grant_type': 'client_credentials',
                'appkey': APP_KEY,
                'secretkey': SECRET_KEY,
            };
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json;charset=UTF-8' },
                body: JSON.stringify(body)
            });
            const data = await response.json();
            if (data.return_code !== 0 || !data.token) {
                throw new Error(data.return_msg || 'í† í° ë°œê¸‰ ì‹¤íŒ¨');
            }
            return data.token;
        }

        async function connectWebSocket() {
            if (ws) {
                log('ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤', 'info');
                return;
            }
            updateStatus('connecting', 'ì—°ê²° ì¤‘...');
            document.getElementById('btnConnect').disabled = true;

            try {
                accessToken = await getAccessToken();
                log('í† í° ë°œê¸‰ ì„±ê³µ', 'info');
            } catch (error) {
                log(`í† í° ë°œê¸‰ ì‹¤íŒ¨: ${error.message}`, 'error');
                updateStatus('disconnected', 'ì—°ê²° ì•ˆë¨');
                document.getElementById('btnConnect').disabled = false;
                return;
            }

            ws = new WebSocket(WS_URL);

            ws.onopen = function() {
                log('WebSocket ì—°ê²° ì„±ê³µ', 'info');
                updateStatus('connected', 'ì—°ê²°ë¨');
                document.getElementById('btnRequest').disabled = true;
                document.getElementById('btnDisconnect').disabled = false;
                sendAuthMessage();
            };

            ws.onmessage = function(event) {
                log(`ìˆ˜ì‹ : ${event.data}`, 'receive');
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (error) {
                    log(`JSON íŒŒì‹± ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            };

            ws.onerror = function() {
                log('WebSocket ì˜¤ë¥˜ ë°œìƒ', 'error');
                updateStatus('disconnected', 'ì˜¤ë¥˜ ë°œìƒ');
            };

            ws.onclose = function(event) {
                log(`WebSocket ì—°ê²° ì¢…ë£Œ: code=${event.code}, reason=${event.reason}`, 'info');
                updateStatus('disconnected', 'ì—°ê²° ì¢…ë£Œ');
                document.getElementById('btnConnect').disabled = false;
                document.getElementById('btnRequest').disabled = true;
                document.getElementById('btnDisconnect').disabled = true;
                authOk = false;
                authPending = false;
                ws = null;
            };
        }

        function sendAuthMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocketì´ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
                return;
            }
            // ê³µì‹ ìƒ˜í”Œ í˜•ì‹: LOGIN íŒ¨í‚·
            const loginPacket = {
                trnm: 'LOGIN',
                token: accessToken
            };
            authPending = true;
            log(`ë¡œê·¸ì¸ íŒ¨í‚· ì „ì†¡: ${JSON.stringify(loginPacket)}`, 'send');
            ws.send(JSON.stringify(loginPacket));
        }

        function requestConditionList() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocketì´ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
                return;
            }

            const msg = {
                trnm: 'CNSRLST',
                header: {
                    'api-id': 'ka10171',
                    authorization: `Bearer ${accessToken}`
                },
                body: {
                    trnm: 'CNSRLST'
                }
            };

            log(`ì¡°ê±´ê²€ìƒ‰ ëª©ë¡ì¡°íšŒ ìš”ì²­: ${JSON.stringify(msg)}`, 'send');
            ws.send(JSON.stringify(msg));
        }

        // ka10172: ì¡°ê±´ê²€ìƒ‰ ìš”ì²­ ì¼ë°˜
        function requestConditionSearch(seq, name) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocketì´ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
                return;
            }

            selectedCondition = { seq, name };
            document.getElementById('selectedCondition').innerHTML =
                `<div class="selected-condition">ì„ íƒëœ ì¡°ê±´: [${seq}] ${name}</div>`;
            document.getElementById('stockResult').innerHTML =
                '<div class="loading">ì¢…ëª© ì¡°íšŒ ì¤‘...</div>';

            // ê³µì‹ ë¬¸ì„œ Request Example í˜•ì‹
            const msg = {
                trnm: 'CNSRREQ',
                seq: seq.toString().trim(),
                search_type: '0',
                stex_tp: 'K',
                cont_yn: 'N',
                next_key: ''
            };

            log(`ì¡°ê±´ê²€ìƒ‰ ìš”ì²­ (ka10172): ${JSON.stringify(msg)}`, 'send');
            ws.send(JSON.stringify(msg));
        }

        function handleMessage(data) {
            // PING ë©”ì‹œì§€ëŠ” ê·¸ëŒ€ë¡œ ì‘ë‹µ (ê³µì‹ ìƒ˜í”Œ ë°©ì‹)
            if (data.trnm === 'PING') {
                ws.send(JSON.stringify(data));
                return;
            }

            // LOGIN ì‘ë‹µ ì²˜ë¦¬
            if (data.trnm === 'LOGIN') {
                if (data.return_code !== 0) {
                    log(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${data.return_msg}`, 'error');
                    renderError(data.return_msg || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
                    return;
                }
                authOk = true;
                authPending = false;
                document.getElementById('btnRequest').disabled = false;
                log('ë¡œê·¸ì¸ ì„±ê³µ', 'info');
                return;
            }

            // ì¡°ê±´ê²€ìƒ‰ ëª©ë¡ ì‘ë‹µ (CNSRLST)
            if (data.trnm === 'CNSRLST') {
                if (data.return_code && String(data.return_code) !== '0') {
                    renderError(data.return_msg || 'ì˜¤ë¥˜');
                    return;
                }
                if (data.data) {
                    renderConditionTable(data.data);
                }
                return;
            }

            // ì¡°ê±´ê²€ìƒ‰ ì¢…ëª© ì‘ë‹µ (CNSRREQ)
            if (data.trnm === 'CNSRREQ') {
                if (data.return_code && String(data.return_code) !== '0') {
                    renderStockError(data.return_msg || 'ì˜¤ë¥˜');
                    return;
                }
                if (data.data) {
                    renderStockList(data.data);
                }
                return;
            }

            // ê¸°íƒ€ ì˜¤ë¥˜ ì²˜ë¦¬
            if (data.return_code && String(data.return_code) !== '0') {
                renderError(data.return_msg || 'ì˜¤ë¥˜');
                return;
            }
        }

        function renderError(message) {
            const result = document.getElementById('result');
            result.innerHTML = `<div class="error">${message}</div>`;
        }

        function renderStockError(message) {
            const result = document.getElementById('stockResult');
            result.innerHTML = `<div class="error">${message}</div>`;
        }

        // ì¡°ê±´ê²€ìƒ‰ì‹ ëª©ë¡ í…Œì´ë¸” (í´ë¦­ ê°€ëŠ¥)
        function renderConditionTable(list) {
            const result = document.getElementById('result');
            const rows = [];

            if (Array.isArray(list)) {
                list.forEach(item => {
                    if (Array.isArray(item)) {
                        rows.push({ seq: item[0], name: item[1] });
                    } else if (item && typeof item === 'object') {
                        rows.push({ seq: item.seq, name: item.name });
                    }
                });
            }

            if (rows.length === 0) {
                result.innerHTML = '<div class="loading">ì¡°ê±´ê²€ìƒ‰ì‹ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ì¼ë ¨ë²ˆí˜¸</th>
                            <th>ì¡°ê±´ê²€ìƒ‰ì‹ ëª…</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            rows.forEach(row => {
                const seq = row.seq || '';
                const name = row.name || '';
                html += `
                    <tr class="clickable" onclick="requestConditionSearch('${seq}', '${name.replace(/'/g, "\\'")}')">
                        <td>${seq || '-'}</td>
                        <td>${name || '-'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            result.innerHTML = html;
        }

        // ì¢…ëª© ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸”
        function renderStockList(list) {
            const result = document.getElementById('stockResult');

            if (!Array.isArray(list) || list.length === 0) {
                result.innerHTML = '<div class="loading">ì¡°ê±´ì— ë§ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            let html = `<div class="stock-count">ì´ ${list.length}ê°œ ì¢…ëª©</div>`;
            html += `
                <table>
                    <thead>
                        <tr>
                            <th>ì¢…ëª©ì½”ë“œ</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th>í˜„ì¬ê°€</th>
                            <th>ì „ì¼ëŒ€ë¹„</th>
                            <th>ë“±ë½ë¥ </th>
                            <th>ê±°ë˜ëŸ‰</th>
                            <th>ì‹œê°€</th>
                            <th>ê³ ê°€</th>
                            <th>ì €ê°€</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            list.forEach(stock => {
                const code = stock['9001'] || '';       // ì¢…ëª©ì½”ë“œ
                const name = stock['302'] || '';        // ì¢…ëª©ëª…
                const price = formatPrice(stock['10']); // í˜„ì¬ê°€
                const sign = stock['25'] || '3';        // ì „ì¼ëŒ€ë¹„ê¸°í˜¸
                const change = formatPrice(stock['11']); // ì „ì¼ëŒ€ë¹„
                const changeRate = formatRate(stock['12']); // ë“±ë½ë¥ 
                const volume = formatVolume(stock['13']); // ëˆ„ì ê±°ë˜ëŸ‰
                const open = formatPrice(stock['16']);  // ì‹œê°€
                const high = formatPrice(stock['17']);  // ê³ ê°€
                const low = formatPrice(stock['18']);   // ì €ê°€

                const priceClass = getPriceClass(sign);
                const signSymbol = getSignSymbol(sign);

                html += `
                    <tr>
                        <td>${code.replace('A', '')}</td>
                        <td>${name}</td>
                        <td class="${priceClass}">${price}</td>
                        <td class="${priceClass}">${signSymbol}${change}</td>
                        <td class="${priceClass}">${changeRate}%</td>
                        <td>${volume}</td>
                        <td>${open}</td>
                        <td>${high}</td>
                        <td>${low}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            result.innerHTML = html;
        }

        // ê°€ê²© í¬ë§·íŒ… (ì•ì˜ 0 ì œê±°)
        function formatPrice(val) {
            if (!val) return '-';
            const num = parseInt(val.replace(/^0+/, '') || '0', 10);
            return num.toLocaleString();
        }

        // ë“±ë½ë¥  í¬ë§·íŒ…
        function formatRate(val) {
            if (!val) return '0.00';
            const num = parseInt(val.replace(/^0+/, '').replace(/^-0+/, '-') || '0', 10);
            return (num / 100).toFixed(2);
        }

        // ê±°ë˜ëŸ‰ í¬ë§·íŒ…
        function formatVolume(val) {
            if (!val) return '-';
            const num = parseInt(val.replace(/^0+/, '') || '0', 10);
            return num.toLocaleString();
        }

        // ì „ì¼ëŒ€ë¹„ê¸°í˜¸ì— ë”°ë¥¸ CSS í´ë˜ìŠ¤
        function getPriceClass(sign) {
            // 1: ìƒí•œ, 2: ìƒìŠ¹, 5: í•˜í•œ, 6: í•˜ë½, 3: ë³´í•©
            if (sign === '1' || sign === '2') return 'price-up';
            if (sign === '5' || sign === '6') return 'price-down';
            return 'price-same';
        }

        // ì „ì¼ëŒ€ë¹„ê¸°í˜¸ì— ë”°ë¥¸ ê¸°í˜¸
        function getSignSymbol(sign) {
            if (sign === '1' || sign === '2') return '+';
            if (sign === '5' || sign === '6') return '-';
            return '';
        }

        function disconnectWebSocket() {
            if (ws) {
                log('WebSocket ì—°ê²° í•´ì œ ìš”ì²­...', 'send');
                ws.close();
            }
        }
    </script>
</body>
</html>
